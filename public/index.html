<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ricette Tradizionali Italiane</title>
    <!-- Material Icons per le icone -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      /* Reset e impostazioni base */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background: linear-gradient(135deg, #f7f7f7, #eaeaea);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        color: #333;
        padding: 20px;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 28px;
        letter-spacing: 1px;
        color: #111;
      }
      /* Sezione Filtri */
      .filter-section {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
      }
      .filter-section input,
      .filter-section select {
        padding: 10px 15px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        width: 250px;
      }
      .filter-section input:focus,
      .filter-section select:focus {
        border-color: #007aff;
        box-shadow: 0 0 8px rgba(0, 122, 255, 0.3);
      }
      /* Griglia delle card delle ricette */
      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 20px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      }
      .card h3 {
        font-size: 20px;
        margin-bottom: 10px;
        color: #111;
      }
      .card p {
        font-size: 14px;
        margin-bottom: 5px;
        color: #555;
      }
      /* Sezione Dettaglio Ricetta */
      .recipe-detail {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 40px;
        position: relative;
      }
      .recipe-detail h2 {
        font-size: 24px;
        margin-bottom: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        text-align: center;
        color: #111;
      }
      .recipe-info {
        text-align: center;
        margin-bottom: 20px;
      }
      .recipe-info p {
        font-size: 16px;
        margin: 5px 0;
        color: #555;
      }
      /* Griglia degli Ingredienti */
      .ingredient-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
      }
      .ingredient-card {
        background-color: #fdfdfd;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
      }
      .ingredient-card:hover {
        background-color: #f9f9f9;
        transform: scale(1.02);
      }
      .ingredient-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 10px;
      }
      .ingredient-label {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 10px;
      }
      .alternative-icons {
        display: flex;
        gap: 8px;
      }
      .alternative-icon {
        font-size: 20px;
        color: #007aff;
      }
      /* Container per alternative espandibili */
      .ingredient-alternatives {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .alternative-chip {
        background: #e0f0ff;
        border-radius: 16px;
        padding: 5px 10px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        transition: background 0.3s ease, color 0.3s ease;
      }
      .alternative-chip .material-icons {
        font-size: 16px;
      }
      .alternative-chip.selected {
        background: #007aff;
        color: #fff;
      }
      /* Pulsante Rielabora */
      #reworkButton {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        background: #007aff;
        color: white;
        cursor: pointer;
        transition: background 0.3s ease;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
      #reworkButton:hover {
        background: #005bb5;
      }
      /* Container per il risultato della rielaborazione */
      .reworked-result {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #f0f0f0;
        font-size: 16px;
      }
      /* Placeholder per il dettaglio */
      .detail-placeholder {
        text-align: center;
        font-size: 18px;
        color: #777;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Ricette Tradizionali Italiane</h1>
      <!-- Sezione Filtri -->
      <div class="filter-section">
        <input type="text" id="searchInput" placeholder="Cerca ricette..." />
        <select id="regionFilter">
          <option value="">Tutte le regioni</option>
        </select>
        <select id="typeFilter">
          <option value="">Tutti i tipi</option>
        </select>
      </div>

      <!-- Griglia delle card delle ricette -->
      <div class="cards-grid" id="cardsGrid">
        <!-- Le card verranno generate dinamicamente -->
      </div>

      <!-- Sezione Dettaglio Ricetta -->
      <div id="recipeDetail" class="recipe-detail">
        <div class="detail-placeholder">
          Seleziona una ricetta per vedere i dettagli
        </div>
      </div>
    </div>

    <script>
      function splitCamelCase(str) {
        // Aggiunge uno spazio prima di ogni lettera maiuscola
        // ma non per la prima lettera della stringa
        const words = str.replace(/([A-Z])/g, " $1").trim(); // Rimuove eventuali spazi extra

        // Capitalizza la prima lettera di ogni parola
        return words
          .split(" ")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }
      document.addEventListener("DOMContentLoaded", () => {
        let recipes = []; // Array globale per le ricette
        let selectedRecipe = null; // Ricetta attualmente selezionata

        /* Mapping dei tipi di alternative a icone e label */
        const alternativeIcons = {
          alternative: { icon: "sync", label: "Alternative" },
          bindingAlternative: { icon: "link", label: "Binding" },
          leaveningAlternative: {
            icon: "emoji_food_beverage",
            label: "Leavening",
          },
          veganAlternative: { icon: "eco", label: "Vegan" },
          vegetarianAlternative: { icon: "spa", label: "Vegetarian" },
        };

        // Funzione helper per estrarre il nome locale da un URI
        const extractLocalName = (uri) => {
          try {
            const url = new URL(uri);
            value = url.pathname.split("/").pop();
            return splitCamelCase(value);
          } catch (e) {
            return uri;
          }
        };

        // Fetch dei dati dal server (endpoint /recipes)
        async function fetchRecipes() {
          try {
            const response = await fetch("/recipes");
            const data = await response.json();
            // Mappatura dei risultati SPARQL in un array di oggetti recipe
            recipes = data.results.bindings.map((item) => ({
              id: extractLocalName(item.recipe.value),
              label: item.label
                ? item.label.value
                : extractLocalName(item.recipe.value),
              region: item.region ? extractLocalName(item.region.value) : "N/D",
              type: item.type ? extractLocalName(item.type.value) : "N/D",
              // La stringa degli ingredienti viene divisa in un array
              ingredients: item.ingredients
                ? item.ingredients.value.split(",").map((i) => i.trim())
                : [],
              topic: item.topic ? item.topic.value : "",
            }));
            populateFilters();
            renderCards();
          } catch (error) {
            console.error("Errore nel recupero delle ricette:", error);
          }
        }

        // Funzione per recuperare le alternative per un dato ingrediente
        async function fetchIngredientAlternatives(ingredient) {
          try {
            cleaned = ingredient.replace("http://dbpedia.org/resource/", "");
            console.log(cleaned);
            const response = await fetch(
              `/alternatives?ingredient=${encodeURIComponent(cleaned)}`
            );
            const data = await response.json();
            return data;
          } catch (error) {
            console.error(
              "Errore nel recupero delle alternative per l'ingrediente:",
              ingredient,
              error
            );
            return null;
          }
        }

        // Popola i filtri per Regione e Tipo
        function populateFilters() {
          const regionFilter = document.getElementById("regionFilter");
          const typeFilter = document.getElementById("typeFilter");

          regionFilter.innerHTML = '<option value="">Tutte le regioni</option>';
          typeFilter.innerHTML = '<option value="">Tutti i tipi</option>';

          const regions = new Set();
          const types = new Set();

          recipes.forEach((recipe) => {
            if (recipe.region && recipe.region !== "N/D")
              regions.add(recipe.region);
            if (recipe.type && recipe.type !== "N/D") types.add(recipe.type);
          });

          regions.forEach((region) => {
            const opt = document.createElement("option");
            opt.value = region;
            opt.textContent = region;
            regionFilter.appendChild(opt);
          });

          types.forEach((type) => {
            const opt = document.createElement("option");
            opt.value = type;
            opt.textContent = type;
            typeFilter.appendChild(opt);
          });
        }

        // Renderizza le card in base ai filtri oppure mostra il dettaglio se una ricetta è selezionata
        function renderCards() {
          const cardsGrid = document.getElementById("cardsGrid");
          if (selectedRecipe) {
            cardsGrid.innerHTML = "";
            return;
          }
          cardsGrid.innerHTML = "";
          const searchTerm = document
            .getElementById("searchInput")
            .value.toLowerCase();
          const selectedRegion = document.getElementById("regionFilter").value;
          const selectedType = document.getElementById("typeFilter").value;

          const filteredRecipes = recipes.filter((recipe) => {
            return (
              recipe.label.toLowerCase().includes(searchTerm) &&
              (selectedRegion === "" || recipe.region === selectedRegion) &&
              (selectedType === "" || recipe.type === selectedType)
            );
          });

          if (filteredRecipes.length === 0) {
            cardsGrid.innerHTML = `<p style="text-align:center; width:100%; color:#777;">Nessuna ricetta trovata.</p>`;
            return;
          }

          filteredRecipes.forEach((recipe) => {
            const card = document.createElement("div");
            card.className = "card";
            card.dataset.id = recipe.id;
            card.innerHTML = `
              <h3>${recipe.label}</h3>
              <p><strong>Regione:</strong> ${recipe.region}</p>
              <p><strong>Tipo:</strong> ${recipe.type}</p>
            `;
            card.addEventListener("click", () => {
              if (selectedRecipe && selectedRecipe.id === recipe.id) {
                selectedRecipe = null;
                document.getElementById("recipeDetail").innerHTML =
                  '<div class="detail-placeholder">Seleziona una ricetta per vedere i dettagli</div>';
                renderCards();
              } else {
                selectedRecipe = recipe;
                cardsGrid.innerHTML = "";
                displayRecipeDetail(recipe);
              }
            });
            cardsGrid.appendChild(card);
          });
        }

        // Mostra il dettaglio della ricetta selezionata, includendo per ogni ingrediente le alternative (se presenti)
        async function displayRecipeDetail(recipe) {
          const detailContainer = document.getElementById("recipeDetail");
          detailContainer.innerHTML = "";

          const title = document.createElement("h2");
          title.textContent = recipe.label;
          detailContainer.appendChild(title);

          const info = document.createElement("div");
          info.className = "recipe-info";
          info.innerHTML = `<p><strong>Regione:</strong> ${recipe.region}</p>
                            <p><strong>Tipo:</strong> ${recipe.type}</p>`;
          detailContainer.appendChild(info);

          const ingredientLabel = document.createElement("h3");
          ingredientLabel.textContent = "Ingredienti:";
          ingredientLabel.style.marginBottom = "15px";
          detailContainer.appendChild(ingredientLabel);

          const grid = document.createElement("div");
          grid.className = "ingredient-grid";

          // Per ciascun ingrediente, crea una card e, se disponibili, mostra le alternative
          for (const ing of recipe.ingredients) {
            const ingCard = document.createElement("div");
            ingCard.className = "ingredient-card";

            const header = document.createElement("div");
            header.className = "ingredient-header";
            const labelSpan = document.createElement("span");
            labelSpan.className = "ingredient-label";
            labelSpan.textContent = ing.replace(
              "http://dbpedia.org/resource/",
              ""
            );

            header.appendChild(labelSpan);
            ingCard.appendChild(header);

            // Esegue la query per le alternative per questo ingrediente
            const altData = await fetchIngredientAlternatives(ing);
            if (altData && altData.results.bindings.length > 0) {
              const altContainer = document.createElement("div");
              altContainer.className = "ingredient-alternatives";

              altData.results.bindings.forEach((binding) => {
                const altType = binding.type.value.split("/").pop(); // Es. "alternative", "veganAlternative"
                const altValues = binding.alternatives.value.split(", "); // Divide la stringa di alternative in array

                if (alternativeIcons[altType]) {
                  altValues.forEach((altLabel) => {
                    const chip = document.createElement("div");
                    chip.className = "alternative-chip";
                    chip.dataset.ingredientId = ing;
                    chip.dataset.alternativeType = altType;
                    chip.dataset.alternativeValue = altLabel;

                    chip.innerHTML = `
            <span class="material-icons">${alternativeIcons[altType].icon}</span>
            <span>${alternativeIcons[altType].label}: ${altLabel}</span>
          `;

                    chip.addEventListener("click", (e) => {
                      e.stopPropagation();
                      chip.classList.toggle("selected");
                    });

                    altContainer.appendChild(chip);
                  });
                }
              });

              ingCard.appendChild(altContainer);
            }

            grid.appendChild(ingCard);
          }

          detailContainer.appendChild(grid);

          // Se presente, mostra il link alla ricetta completa
          if (recipe.topic) {
            const link = document.createElement("a");
            link.href = recipe.topic;
            link.textContent = "Vai alla ricetta completa";
            link.target = "_blank";
            detailContainer.appendChild(link);
          }

          // Pulsante per simulare la richiesta di rielaborazione
          const reworkBtn = document.createElement("button");
          reworkBtn.id = "reworkButton";
          reworkBtn.textContent = "Rielabora Ricetta";
          reworkBtn.addEventListener("click", () => processRework(recipe));
          detailContainer.appendChild(reworkBtn);

          // Pulsante per tornare alla lista delle ricette
          const backBtn = document.createElement("button");
          backBtn.textContent = "Torna alla lista";
          backBtn.style.marginLeft = "10px";
          backBtn.addEventListener("click", () => {
            selectedRecipe = null;
            document.getElementById("recipeDetail").innerHTML =
              '<div class="detail-placeholder">Seleziona una ricetta per vedere i dettagli</div>';
            renderCards();
          });
          detailContainer.appendChild(backBtn);
        }

        // Funzione per simulare la rielaborazione della ricetta
        function processRework(recipe) {
          console.log("Processa rielaborazione per:", recipe);
          const detailContainer = document.getElementById("recipeDetail");
          const resultContainer = document.createElement("div");
          resultContainer.className = "reworked-result";
          resultContainer.textContent = "Rielaborazione in corso...";
          detailContainer.appendChild(resultContainer);

          setTimeout(() => {
            resultContainer.textContent =
              "Ricetta rielaborata:\n" + JSON.stringify(recipe, null, 2);
          }, 1500);
        }

        // Event listeners per i filtri: se il filtro cambia, deseleziona eventualmente la ricetta corrente
        document.getElementById("searchInput").addEventListener("input", () => {
          if (selectedRecipe) {
            selectedRecipe = null;
            document.getElementById("recipeDetail").innerHTML =
              '<div class="detail-placeholder">Seleziona una ricetta per vedere i dettagli</div>';
          }
          renderCards();
        });
        document
          .getElementById("regionFilter")
          .addEventListener("change", () => {
            if (selectedRecipe) {
              selectedRecipe = null;
              document.getElementById("recipeDetail").innerHTML =
                '<div class="detail-placeholder">Seleziona una ricetta per vedere i dettagli</div>';
            }
            renderCards();
          });
        document.getElementById("typeFilter").addEventListener("change", () => {
          if (selectedRecipe) {
            selectedRecipe = null;
            document.getElementById("recipeDetail").innerHTML =
              '<div class="detail-placeholder">Seleziona una ricetta per vedere i dettagli</div>';
          }
          renderCards();
        });

        // Inizializza il caricamento dei dati
        fetchRecipes();
      });
    </script>
  </body>
</html>
